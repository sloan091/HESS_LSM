# HESS_LSM
This repository contains the MATLAB codes for the dual-source, two-big-leaf land surface model (LSM) from Sloan et al. (2021). The provided codes recreate the LSM predictions for the US-Me2 ponderosa pine site using the five separate transpiration downregulation schemes in the article. For full details refer to:

Sloan, B. P., Thompson, S. E., and Feng, X.: Plant hydraulic transport controls transpiration response to soil water stress, Hydrol. Earth Syst. Sci., https://doi.org/10.5194/hess-2020-671, 2021.

This LSM was coded using MATLAB version 2018b and should only require the Optimization Toolbox for nonlinear least squares.  Below is a brief description of the folders contained in this repository. Please contact me at sloan091@umn.edu if there are any issues.

## RunLSM
The *RunLSM* folder contains the main wrapper script(s) for running the LSM and should be your starting point. These scripts load in the LSM forcing data and parameter file, execute the main LSM function, and save the outputs. The LSM can be run either serially or in parallel mode by executing the _LSM_Serial.m_ or _LSM_Parallel.m_ script in MATLAB and ensuring all folders are on your MATLAB search path.  For the simulations in Sloan et al. (2021), the serial version takes approximately 30 minutes to run, whereas the parallel mode takes approximately 3 minutes using 24 cores. The _Run_LSM_pbs.txt_ is an example PBS script for submitting the parallel LSM to a supercomputer, which will require user modifications to ensure the syntax matches your particular system. 

## Parameters
I have included three separate parameter files to recreate all the simulations in the Sloan et al. (2021): *Parameters_HESS_PHM_and_beta_s.mat*, *Parameters_HESS_PHM_and_beta_2L.mat*, and *Parameters_HESS_PHM_and_beta_dyn.mat*. Simply replace parameter file name loaded in the _LSM_Serial.m_ or _LSM_Parallel.m_ scripts to switch between parameter files. Each parameter file runs the identical well-watered and PHM downregulation simulation, but uses a different beta downregulation scheme: 1) a single beta applied to both sunlit and shaded big leaves (beta_s), 2) a beta applied separately to sunlit and shaded big leaves (beta_2L), and 3) the dynamic beta that varies with atmospheric moisture demand applied separately to sunlit and shaded big leaves (beta_dyn). The user can update these parameter files to run only certain simulations by editing the Flag structure.  By default, any LSM run will calculate the well-watered simulation as it is used for the downregulation schemes.  Setting the Betaflag or PHMflag values can toggle these downregulation simulations on or off.  Please see the *Parameter_File_Creator_HESS.m* script for the flag value definitions.   

## Results
I have included the LSM simulation results for each parameter file as used in Sloan et al. (2021). Each results .mat file contains 3 MATLAB tables containing the selected state and flux predictions corresponding to the LSM run with: 1) well-watered conditions (_WW), 2) beta transpiration downregulation (_Beta), and 3) PHM transpiration downregulation (_PHM).  If the flags for either transpiration downregulation scheme are turned off, the tables contain zeros. The definitions and units for the LSM results are detailed in the *Utilities/storeOutputs.m* script.    

## Modules
The *Modules* folder contains several subfolders organizing all the LSM modules (i.e., MATLAB functions). Each MATLAB function file contains a brief description, clearly defined inputs and outputs, and references. Additionally, I have included significant annotation and consistent variables names (to the best of my ability) to aid matching up these codes with the detailed LSM description given in Sect. S2-S3 in the Supplement of Sloan et al. (2021). For those interested in the LSM inner workings, I would recommend starting with *Solvers/runLSMParallel.m* or *Solvers/runLSMSerial.m* as these are the main functions that coordinate the use of all other modules.

## FluxData
The *FluxData* folder contains the overall combined FLUXNET2015/Ameriflux US-Me2 dataset (*FLX_US_Me2.mat*) as well as the subset of this dataset used to force the LSM (*FLX_US_Me2_LSM_Forcing.mat*) for daylight hours during May-August 2013-2014. Both the US-Me2 FLUXNET2015 (https://doi.org/10.1038/s41597-020-0534-3) and Ameriflux (https://doi.org/10.17190/AMF/1246076) data products were used in Sloan et al. (2021) because the former provides more gap-filling and quality control over the latter; however, the latter contains soil moisture and temperature profiles ommitted in the former. I have provided the *Create_US_Me2_LSM_Forcing.m* script to illustrate how the *FLX_US_Me2.mat* was trimmed down to the *FLX_US_Me2_LSM_Forcing.mat* used in the article. See *Utilities/createBCs.m* for details on how *FLX_US_Me2_LSM_Forcing.mat* is used for force the LSM and Sect. S5 of Sloan et al. (2021) for full details on the data. 

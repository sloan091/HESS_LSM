# HESS_LSM
This repository contains the MATLAB codes for the dual-source, two-big-leaf land surface model used Sloan et al. (2021). The provided codes allow users to recreate the simulation results for the US-Me2 ponderosa pine site using the five separate transpiration downregulation schemes. For full details refer to:

Sloan, B. P., Thompson, S. E., and Feng, X.: Plant hydraulic transport controls transpiration response to soil water stress, Hydrol. Earth Syst. Sci., https://doi.org/10.5194/hess-2020-671, 2021.

This LSM was coded using MATLAB version 2018b and should only require the Optimization Toolbox for nonlinear least squares.  Below is a brief description of the content of the folders in this repository. Please contact me at sloan091@umn.edu if there are any issues.

## RunLSM
The LSM can be run either serially or in parallel mode by executing the _LSM_Serial.m_ or _LSM_Parallel.m_ scripts in MATLAB and ensuring all folders on in your MATLAB search path.  For the simulations in Sloan et al. (2021), the serial version takes approximately 30 minutes to run, whereas the parallel mode takes approximately 3 minutes using 24 cores. The _Run_LSM_pbs.txt_ is an example PBS script for submitting the parallel LSM to a supercomputer, which will require user modifications to ensure the syntax matches your particular system.

## Parameters
I have included three separate parameter files that can be used to create all the simulations in the Sloan et al. (2021): *Parameters_HESS_PHM_and_beta_s.mat*, *Parameters_HESS_PHM_and_beta_2L.mat*, and *Parameters_HESS_PHM_and_beta_dyn.mat*. Simply replace parameter file name loaded in the _LSM_Serial.m_ or _LSM_Parallel.m_ scripts. Each parameter file runs the identical well-watered and PHM downregulation simulation, but uses a different beta downregulation scheme: 1) a single beta applied to both sunlit and shaded big leaves (beta_s), 2) a beta applied separately to sunlit and shaded big leaves (beta_2L), and 3) the dynamic beta that varies with atmospheric moisture demand applied to separately to sunlit and shaded big leaves (beta_dyn). The user can update these parameter files to run only certain simulations by editing the Flag structure.  By default, any LSM run will calculate the well-watered simulation as it is used for the downregulation schemes.  Setting the Betaflag or PHMflag values can toggle these downregulation simulations on or off.  Please see the *Parameter_File_Creator_HESS.m* script for the flag value definitions.   

## Results
I have included the LSM simulation results for each parameter file as used in Sloan et al (2021). Each results .mat file contains 3 MATLAB tables of the selected states and fluxes from the LSM run assuming: 1) well-watered condition (_WW), 2) beta transpiration downregulation (_Beta), and 3) PHM transpiration downregulation (_PHM).  If the flags for either transpiration downregulation scheme are turned off, the tables contain zeros. The definitions and units for the results are detailed in the *Utilities/storeOutputs.m* script.    

## Modules
The *Modules* folder contains several subfolders organizing all the LSM modules (i.e., MATLAB functions). Each MATLAB function file contains a brief description referencing the Supplement sections of Sloan et al. (2021) and/or the relevant literature used to create it as well a clearly and consistently defined inputs and outputs. Additionally, I have included significant annotation and consistent variables names to aid matching up these codes with the detailed LSM description given in Sect. S2-S3 in the Supplement of Sloan et al. (2021). For those interested in the LSM inner workings, I would recommend starting with *Solvers/runLSMParallel.m* or *Solvers/runLSMSerial.m* as these are the main functions that coordinate the use of all other modules.

## FluxData
I have included the combined FLUXNET2015 and AmeriFlux data set for the US-Me2 ponderosa pine site used to force the LSM in Sloan et al. (2021). Essentially, all the selected states and fluxes are from teh FLUXNET2015 data product (https://doi.org/10.1038/s41597-020-0534-3) as there is significant gap-filling and quality control compared to the original AmeriFlux product (https://doi.org/10.17190/AMF/1246076).  However, soil moisture and soil temperatures at various depths are taken from the AmeriFlux dataset, as the FLUXNET2015 product omits quite a few of these sensors.   See *Utilities/createBCs* for details of these measurements are used to force the LSM and Sect. S5 of Sloan et al. (2021) for full details on the data.
